CREATE OR REPLACE TABLE `${truecall_src_project_id}.${truecall_src_dataset_name}.${truecall_source_tblname}`
PARTITION BY DATE(trans_date)  -- Optional: Partitioning by date for improved query performance
CLUSTER BY trans_dt, arrival_dt_hr AS
SELECT * FROM `${truecall_src_project_id}.${truecall_src_dataset_name}.${truecall_source_tblname}`;


WITH preprocessed_data AS (
    SELECT
        *,
        CAST(trans_date AS DATE) AS trans_date_casted,
        arrival_dt_hr AS arrival_dt_hr_casted
    FROM `${truecall_src_project_id}.${truecall_src_dataset_name}.${truecall_source_tblname}`
)


INSERT INTO `${truecall_tgt_project_id}.${truecall_tgt_dataset_name}.${truecall_target_tblname}` (
    environment,
    end_location_lat,
    end_location_lon,
    model,
    make,
    service_type,
    start_m_tmsi,
    start_time,
    duration,
    end_time,
    start_type,
    end_type,
    final_disposition,
    start_cell,
    start_enb,
    end_cell,
    end_enb,
    s1_release_cause,
    rsrp_dbm,
    rsrq_db,
    end_timing_advance_meters,
    intra_frequency_intra_enb_ho_attempts,
    intra_frequency_intra_enb_ho_failures,
    inter_frequency_intra_enb_ho_attempts,
    inter_frequency_intra_enb_ho_failures,
    intra_frequency_x2_ho_prep_attempts,
    intra_frequency_x2_ho_prep_failures,
    inter_frequency_x2_ho_exec_failures,
    inter_frequency_x2_ho_prep_attempts,
    intra_frequency_x2_ho_exec_failures,
    inter_frequency_s1_ho_prep_attempts,
    inter_frequency_s1_ho_prep_failures,
    intra_frequency_s1_ho_exec_failures,
    intra_frequency_s1_ho_prep_attempts,
    intra_frequency_s1_ho_prep_failures,
    inter_frequency_s1_ho_exec_failures,
    irat_ho_attempts,
    last_volte_erab_duration,
    last_volte_erab_end_time,
    last_volte_erab_release_cause,
    last_volte_erab_start_time,
    volte_erab_with_emergency_arp,
    initial_nas_request,
    initial_nas_response,
    oem_rrc_setup_cause,
    oem_s1_setup_cause,
    oem_s1_release_cause,
    oem_internal_release_cause,
    release_with_data_lost,
    data_lost,
    mean_cqi,
    mac_volume_dl_bytes,
    mac_volume_ul_bytes,
    pdcp_volume_dl_bytes,
    pdcp_volume_ul_bytes,
    mean_pdcp_drb_throughput_dl_kbps,
    mean_pdcp_drb_throughput_ul_kbps,
    enb_cfcq,
    dl_ttis_ue_scheduled,
    end_earfcn_dl,
    qci_list,
    rrc_re_establishment_failures,
    rrc_re_establishment_successes,
    num_of_neighbors,
    n1_rsrp_dbm,
    n2_rsrp_dbm,
    n3_rsrp_dbm,
    pusch_sinr_db,
    ue_power_headroom_db,
    ta_distance_meters,
    intersite_distance_meters,
    imei,
    imsi,
    volte_erab_attempts,
    volte_erab_drops,
    volte_erab_duration,
    volte_erab_failed_attempts,
    volte_erab_release_attempts,
    rlc_dl_throughput_kbps,
    rlc_pdu_dl_retransmit_rate_percentage,
    rlc_pdu_dl_retransmitted_volume_bytes,
    rlc_pdu_dl_volume_bytes,
    rlc_pdu_ul_volume_bytes,
    rlc_sdu_ul_volume_kbytes,
    rlc_ul_throughput_kbps,
    mobile_number,
    mean_ul_sinr_db,
    vendor,
    confidence,
    nr_serving_cell,
    nr_serving_pci,
    nr_serving_arfcn,
    en_dc_duration,
    en_dc_duration_rate_percentage,
    maximum_number_of_carrier_components,
    average_number_of_carrier_components,
    en_dc_sgnb_addition_attempts,
    en_dc_sgnb_addition_failures,
    en_dc_sgnb_drops,
    last_5g_en_dc_release_cause,
    en_dc_downlink_volume_bytes,
    en_dc_uplink_volume_bytes,
    time_of_last_rrc_measurement_reports_with_5g_nr_cell,
    nr_last_measurement_cell,
    nr_last_measurement_pci,
    nr_last_measurement_arfcn,
    nr_rsrp_dbm,
    nr_rsrq_db,
    nr_dl_sinr_db,
    en_dc_sgnb_change_attempts,
    en_dc_sgnb_change_failures,
    en_dc_sgnb_modification_attempts,
    en_dc_sgnb_modification_failures,
    radio_type,
    call_release_cause,
    s1_u_ul_data_volume_bytes,
    s1_u_dl_data_volume_bytes,
    mean_uplink_ip_throughput_kbps,
    mean_downlink_ipthroughput_kbps,
    call_type,
    last_rrc_reestablishment_case,
    last_cqi,
    csl_event,
    call_segment_duration,
    last_ue_tx_power,
    csfb,
    csfb_result,
    csfb_type,
    ue_5g_capable,
    nr_final_disposition,
    lte_carrier_aggregation_service_time,
    nr_carrier_aggregation_service_time,
    intra_frequency_x2_ho_exec_attempts,
    inter_frequency_x2_ho_exec_attempts,
    rrc_re_establishment_attempts,
    nr_scg_failure_type,
    mean_mac_throughput_ul_kbps,
    mean_mac_throughput_dl_kbps,
    composite_call,
    fragment_id,
    global_id,
    erab_drops,
    nr_n1_pci,
    nr_n1_cell,
    nr_n1_rsrp_dbm,
    nr_n1_dl_sinr_db,
    nr_n2_pci,
    nr_n2_cell,
    nr_n2_rsrp_dbm,
    nr_n2_dl_sinr_db,
    avg_num_of_nr_carrier_components,
    nr_scell_list,
    nr_scell_arfcn_list,
    lte_scell_list,
    lte_scell_arfcn_list,
    lte_carrier_aggregation_service_rate_percentage,
    erab_attempts,
    erab_failed_attempts,
    erab_normal_releases,
    erab_release_attempts,
    erab_successes,
    lte_mkt,
    lte_base_mkt,
    submkt,
    duration_seconds,
    call_segment_duration_seconds,
    en_dc_duration_seconds,
    volte_erab_duration_seconds,
    last_volte_erab_duration_seconds,
    h3_06,
    h3_07,
    h3_08,
    h3_09,
    mgrs_1m,
    conn_tech_type,
    conn_tech_type_desc,
    enb_gnb_id,
    start_cell_sector,
    channel,
    end_cell_sector,
    new_carr,
    trans_dt,
    hr,
    submkt_fname,
    process_dt
FROM preprocessed_data
WHERE trans_dt >= trans_date_casted AND arrival = arrival_dt_hr_casted;
